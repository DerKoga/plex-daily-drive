<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plex Daily Drive</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>&#9654; Plex Daily Drive</h1>
            <p class="subtitle">Automatische Playlist-Erstellung &mdash; Musik &amp; Podcasts gemischt</p>
        </header>

        <!-- Status Bar -->
        <div class="card status-card" id="status-card">
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Plex Server</span>
                    <span class="status-value" id="plex-status">Verbinde...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Scheduler</span>
                    <span class="status-value" id="scheduler-status">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">N&auml;chste Ausf&uuml;hrung</span>
                    <span class="status-value" id="next-run">--</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <nav class="tabs">
            <button class="tab active" data-tab="settings">Einstellungen</button>
            <button class="tab" data-tab="users">Benutzer</button>
            <button class="tab" data-tab="podcasts">Podcasts</button>
            <button class="tab" data-tab="generate">Generieren</button>
            <button class="tab" data-tab="history">Verlauf</button>
        </nav>

        <!-- Settings Tab -->
        <div class="tab-content active" id="tab-settings">
            <div class="card">
                <h2>Plex Verbindung</h2>
                <div class="form-group">
                    <label for="plex-url">Plex URL</label>
                    <input type="text" id="plex-url" placeholder="http://192.168.1.x:32400">
                    <small>IP-Adresse deines Plex Servers (nicht localhost wenn Docker!)</small>
                </div>
                <div class="form-group">
                    <label for="plex-token">Plex Token</label>
                    <div class="token-field">
                        <input type="password" id="plex-token" placeholder="Dein Plex Token">
                        <button type="button" class="btn btn-small btn-secondary" onclick="toggleToken()">Zeigen</button>
                    </div>
                    <small><a href="https://support.plex.tv/articles/204059436/" target="_blank" rel="noopener">Wie finde ich meinen Plex Token?</a></small>
                </div>
                <button class="btn btn-secondary" onclick="testConnection()">Verbindung testen</button>
                <div id="connection-result" class="result-box hidden"></div>
            </div>

            <div class="card">
                <h2>Podcast-Einstellungen</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="podcast-download-path">Podcast Download-Pfad</label>
                        <input type="text" id="podcast-download-path" value="/podcasts">
                        <small>Ordner in dem Podcast-Episoden gespeichert werden</small>
                    </div>
                    <div class="form-group">
                        <label for="podcast-max-episodes">Max. Episoden pro Podcast</label>
                        <input type="number" id="podcast-max-episodes" value="3" min="1" max="50">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Zeitplan</h2>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="enabled" checked>
                        Automatische Generierung aktiviert
                    </label>
                </div>
                <div class="form-group">
                    <label>Generierungszeiten</label>
                    <div id="schedules-list"></div>
                    <button class="btn btn-secondary btn-small" onclick="addSchedule()" style="margin-top: 8px">+ Zeit hinzuf&uuml;gen</button>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="saveSettings()">Einstellungen speichern</button>
                <div id="save-result" class="result-box hidden"></div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-content" id="tab-users">
            <div class="card">
                <h2>Neuen Benutzer hinzuf&uuml;gen</h2>
                <div class="form-group">
                    <label for="new-user-name">Name</label>
                    <input type="text" id="new-user-name" placeholder="z.B. Max">
                </div>
                <div class="form-group">
                    <label for="new-user-plex-username">Plex Benutzername</label>
                    <input type="text" id="new-user-plex-username" placeholder="Plex Home-User Name">
                    <small>Der Name des Plex-Benutzers (Home User / Managed User). Wiedergaben und Likes werden von diesem Benutzer gezogen.</small>
                </div>
                <div class="form-group">
                    <label for="new-user-plex-token">Plex Token (optional)</label>
                    <div class="token-field">
                        <input type="password" id="new-user-plex-token" placeholder="Eigener Token (optional)">
                        <button type="button" class="btn btn-small btn-secondary" onclick="toggleNewUserToken()">Zeigen</button>
                    </div>
                    <small>Nur n&ouml;tig wenn switchUser nicht funktioniert. Leer lassen f&uuml;r automatische Erkennung.</small>
                </div>
                <div class="form-group">
                    <label>Plex-Benutzer auf dem Server</label>
                    <div id="plex-users-list" class="muted">Lade Plex-Benutzer...</div>
                </div>
                <button class="btn btn-primary" onclick="addUser()">Benutzer hinzuf&uuml;gen</button>
                <div id="add-user-result" class="result-box hidden"></div>
            </div>

            <div class="card">
                <h2>Benutzer verwalten</h2>
                <div id="users-list">
                    <p class="muted">Lade...</p>
                </div>
            </div>
        </div>

        <!-- User Edit Modal -->
        <div class="modal-overlay hidden" id="user-edit-modal">
            <div class="modal card">
                <h2>Benutzer bearbeiten</h2>
                <input type="hidden" id="edit-user-id">

                <div class="form-group">
                    <label for="edit-user-name">Name</label>
                    <input type="text" id="edit-user-name">
                </div>
                <div class="form-group">
                    <label for="edit-user-plex-username">Plex Benutzername</label>
                    <input type="text" id="edit-user-plex-username">
                </div>
                <div class="form-group">
                    <label for="edit-user-plex-token">Plex Token (optional)</label>
                    <input type="password" id="edit-user-plex-token" placeholder="Leer = switchUser">
                </div>
                <div class="form-group">
                    <label for="edit-user-prefix">Playlist-Name Prefix</label>
                    <input type="text" id="edit-user-prefix">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-user-music-count">Musiktitel</label>
                        <input type="number" id="edit-user-music-count" min="0" max="200">
                    </div>
                    <div class="form-group">
                        <label for="edit-user-podcast-count">Podcast-Episoden</label>
                        <input type="number" id="edit-user-podcast-count" min="0" max="50">
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-user-discovery">Neuentdeckungen: <span id="edit-discovery-label">40%</span></label>
                    <div class="slider-row">
                        <span class="slider-label">Favoriten</span>
                        <input type="range" id="edit-user-discovery" min="0" max="100" value="40" step="5"
                               oninput="document.getElementById('edit-discovery-label').textContent=this.value+'%'">
                        <span class="slider-label">Neuentdeckungen</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-user-keep-days">Aufbewahren (Tage)</label>
                    <input type="number" id="edit-user-keep-days" min="1" max="365">
                </div>

                <div class="form-group">
                    <label>Musik-Bibliotheken</label>
                    <div id="edit-user-libraries" class="library-list">
                        <p class="muted">Lade...</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Podcasts f&uuml;r diesen Benutzer</label>
                    <div id="edit-user-podcasts" class="library-list">
                        <p class="muted">Lade...</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-user-description">Playlist-Beschreibung</label>
                    <textarea id="edit-user-description" rows="3" placeholder="Beschreibung f&uuml;r die Playlist..."></textarea>
                    <small>Wird als Beschreibung in Plex angezeigt</small>
                </div>

                <div class="form-group">
                    <label>Playlist-Cover</label>
                    <div class="cover-section">
                        <div class="cover-preview" id="edit-cover-preview">
                            <img id="edit-cover-img" src="" alt="Cover"
                                 onerror="this.style.display='none'; document.getElementById('edit-cover-placeholder').style.display='flex'"
                                 style="display:none">
                            <div id="edit-cover-placeholder" class="cover-placeholder">Kein Cover</div>
                        </div>
                        <div class="cover-actions">
                            <label class="btn btn-secondary btn-small" for="edit-cover-upload">Bild ausw&auml;hlen</label>
                            <input type="file" id="edit-cover-upload" accept="image/*" onchange="uploadUserCover(this)" style="display:none">
                            <button class="btn btn-small btn-danger" onclick="deleteUserCover()">Entfernen</button>
                        </div>
                    </div>
                    <div id="edit-cover-result" class="result-box hidden"></div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="saveUser()">Speichern</button>
                    <button class="btn btn-secondary" onclick="closeUserModal()">Abbrechen</button>
                </div>
                <div id="edit-user-result" class="result-box hidden"></div>
            </div>
        </div>

        <!-- Podcasts Tab -->
        <div class="tab-content" id="tab-podcasts">
            <div class="card">
                <h2>Podcast suchen</h2>
                <div class="search-field">
                    <input type="text" id="podcast-search-input" placeholder="Podcast Name eingeben...">
                    <button class="btn btn-primary" onclick="searchPodcasts()">Suchen</button>
                </div>
                <div id="podcast-search-results"></div>
            </div>

            <div class="card">
                <h2>Abonnierte Podcasts</h2>
                <div id="subscribed-podcasts">
                    <p class="muted">Lade...</p>
                </div>
                <button class="btn btn-secondary" onclick="refreshPodcasts()" id="refresh-podcasts-btn" style="margin-top: 12px">
                    Jetzt neue Episoden laden
                </button>
                <div id="refresh-result" class="result-box hidden"></div>
            </div>
        </div>

        <!-- Generate Tab -->
        <div class="tab-content" id="tab-generate">
            <div class="card center-card">
                <h2>Playlist jetzt generieren</h2>
                <p>Erstellt sofort eine neue Daily Drive Playlist.</p>
                <div class="form-group">
                    <label for="generate-user-select">Benutzer</label>
                    <select id="generate-user-select" class="form-select">
                        <option value="">Alle Benutzer / Global</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-large" id="generate-btn" onclick="generateNow()">
                    Jetzt generieren
                </button>
                <div id="generate-result" class="result-box hidden"></div>
            </div>

            <div class="card">
                <h2>Aktive Playlists</h2>
                <div id="active-playlists">
                    <p class="muted">Lade...</p>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="tab-history">
            <div class="card">
                <h2>Generierungsverlauf</h2>
                <div id="history-list">
                    <p class="muted">Lade...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
